//@version=5
indicator("WT + Ideal BB + RSI", shorttitle="WT+BB+RSI", overlay=false)

// ============================================================================
// CLOSED CANDLE LOGIC & NEXT CANDLE ENTRY BEHAVIOR
// ============================================================================
// This indicator uses ONLY closed candle data (no intrabar values)
// - All signal detection occurs on confirmed/closed candles only
// - Entry signals trigger on the NEXT candle open (after conditions met)
// - This ensures accurate backtesting and prevents intrabar execution
// ============================================================================

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// WaveTrend (WT) Parameters - LazyBear Style
wt_channel_length = input.int(10, title="WT Channel Length", minval=1)
wt_average_length = input.int(21, title="WT Average Length", minval=1)
wt_malawi = input.float(0.0, title="WT Malawi", step=0.1)
show_wt_dots = input.bool(true, title="Show WT Cross Dots")

// Ideal Bollinger Bands Parameters
bb_length = input.int(20, title="BB Length", minval=1)
bb_mult = input.float(2.0, title="BB Multiplier", step=0.1)
bb_source = input.source(close, title="BB Source")

// Moving Average Parameters for Ideal BB Alerts
ma_length = input.int(20, title="MA Length", minval=1)
ma_type = input.string("EMA", title="MA Type", options=["SMA", "EMA", "WMA", "RMA"])
show_bb_labels = input.bool(true, title="Show BB Buy/Sell Labels")

// RSI Parameters
rsi_length = input.int(12, title="RSI Length", minval=1)
rsi_source = input.source(close, title="RSI Source")

// RSI Buy/Sell Thresholds (Ranges)
rsi_buy_threshold_min = input.float(54.0, title="RSI Buy Threshold Min (>=)", minval=0, maxval=100, step=0.1)
rsi_buy_threshold_max = input.float(82.0, title="RSI Buy Threshold Max (<=)", minval=0, maxval=100, step=0.1)
rsi_sell_threshold_min = input.float(27.0, title="RSI Sell Threshold Min (>=)", minval=0, maxval=100, step=0.1)
rsi_sell_threshold_max = input.float(43.0, title="RSI Sell Threshold Max (<=)", minval=0, maxval=100, step=0.1)
show_rsi_signals = input.bool(true, title="Show RSI Buy/Sell Signals")

// Display Options
show_wt = input.bool(true, title="Show WaveTrend")
show_bb = input.bool(true, title="Show Ideal BB")
show_rsi = input.bool(true, title="Show RSI")

// Strategy Options
enable_strategy = input.bool(true, title="Enable Combined Strategy")
show_strategy_signals = input.bool(true, title="Show Strategy Buy/Sell Signals")

// ============================================================================
// WAVETREND (WT) INDICATOR - LazyBear Implementation
// ============================================================================

// LazyBear WaveTrend Calculation
ap = hlc3  // Average Price (High + Low + Close) / 3
esa = ta.ema(ap, wt_channel_length)
d = ta.ema(math.abs(ap - esa), wt_channel_length)
ci = (ap - esa) / (0.015 * d)
tci = ta.ema(ci, wt_average_length)

// WT1 and WT2 - LazyBear Style (WT2 is EMA of WT1, not SMA)
wt1 = tci
wt2 = ta.ema(tci, wt_average_length)

// WaveTrend Cross Signals - LazyBear Cross Logic (Closed Candle Only)
// Only detect crosses on confirmed/closed candles
wt_cross_up = barstate.isconfirmed and ta.crossover(wt1, wt2)      // Bullish: WT1 crosses above WT2
wt_cross_down = barstate.isconfirmed and ta.crossunder(wt1, wt2)   // Bearish: WT1 crosses below WT2

// ============================================================================
// IDEAL BOLLINGER BANDS WITH MA ALERTS
// ============================================================================

bb_basis = ta.sma(bb_source, bb_length)
bb_dev = bb_mult * ta.stdev(bb_source, bb_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

// Ideal BB Bands (using EMA instead of SMA for smoother bands)
ideal_bb_basis = ta.ema(bb_source, bb_length)
ideal_bb_dev = bb_mult * ta.stdev(bb_source, bb_length)
ideal_bb_upper = ideal_bb_basis + ideal_bb_dev
ideal_bb_lower = ideal_bb_basis - ideal_bb_dev

// Moving Average Calculation
ma_value = ma_type == "SMA" ? ta.sma(bb_source, ma_length) : 
           ma_type == "EMA" ? ta.ema(bb_source, ma_length) : 
           ma_type == "WMA" ? ta.wma(bb_source, ma_length) : 
           ta.rma(bb_source, ma_length)

// Ideal BB with MA Buy/Sell Signals (Closed Candle Only)
// Buy Signal: Price crosses above MA (classic MA crossover buy signal)
bb_buy_signal = barstate.isconfirmed and ta.crossover(close, ma_value)

// Sell Signal: Price crosses below MA (classic MA crossover sell signal)
bb_sell_signal = barstate.isconfirmed and ta.crossunder(close, ma_value)

// Enhanced Buy Signal: Price crosses above MA AND price is near or below lower BB (oversold bounce)
bb_buy_enhanced = ta.crossover(close, ma_value) and close <= ideal_bb_lower * 1.01

// Enhanced Sell Signal: Price crosses below MA AND price is near or above upper BB (overbought rejection)
bb_sell_enhanced = ta.crossunder(close, ma_value) and close >= ideal_bb_upper * 0.99

// BB Percent B (%B)
bb_percent = (bb_source - bb_lower) / (bb_upper - bb_lower)

// BB Bandwidth
bb_bandwidth = (bb_upper - bb_lower) / bb_basis * 100

// ============================================================================
// RSI INDICATOR
// ============================================================================

rsi = ta.rsi(rsi_source, rsi_length)

// RSI Levels (Traditional)
rsi_overbought = 70
rsi_oversold = 30

// RSI Traditional Signals
rsi_overbought_signal = ta.crossover(rsi, rsi_overbought)
rsi_oversold_signal = ta.crossunder(rsi, rsi_oversold)

// RSI Buy/Sell Signals based on Custom Threshold Ranges (Closed Candle Only)
// Buy Signal: RSI enters buy range (54-82)
rsi_buy_signal = barstate.isconfirmed and (rsi >= rsi_buy_threshold_min and rsi <= rsi_buy_threshold_max) and (rsi[1] < rsi_buy_threshold_min or rsi[1] > rsi_buy_threshold_max)
rsi_buy_active = rsi >= rsi_buy_threshold_min and rsi <= rsi_buy_threshold_max  // RSI is within buy range

// Sell Signal: RSI enters sell range (27-43)
rsi_sell_signal = barstate.isconfirmed and (rsi >= rsi_sell_threshold_min and rsi <= rsi_sell_threshold_max) and (rsi[1] < rsi_sell_threshold_min or rsi[1] > rsi_sell_threshold_max)
rsi_sell_active = rsi >= rsi_sell_threshold_min and rsi <= rsi_sell_threshold_max  // RSI is within sell range

// ============================================================================
// COMBINED STRATEGY LOGIC - WT + Ideal BB + RSI (Closed Candle + Next Candle Entry)
// ============================================================================

// Track WT cross events with one candle window on each side
// Window logic: When WT cross occurs on confirmed bar N, validate on bars N-1, N, N+1
// All conditions checked on CLOSED candles only, entry occurs on NEXT candle open

var int wt_buy_window_bars = 0
var int wt_sell_window_bars = 0

// When WT buy cross occurs on confirmed bar, start 3-bar window
if wt_cross_up  // wt_cross_up already checks barstate.isconfirmed
    wt_buy_window_bars := 2  // Current confirmed bar + 1 more bar (previous bar checked via [1])
else if wt_buy_window_bars > 0
    wt_buy_window_bars -= 1

// When WT sell cross occurs on confirmed bar, start 3-bar window  
if wt_cross_down  // wt_cross_down already checks barstate.isconfirmed
    wt_sell_window_bars := 2  // Current confirmed bar + 1 more bar
else if wt_sell_window_bars > 0
    wt_sell_window_bars -= 1

// Check if we're within WT buy window (only evaluate on confirmed bars)
// Include previous confirmed bar via [1], current confirmed bar, or next bar if window active
wt_buy_window_active = wt_buy_window_bars > 0 or wt_cross_up or wt_cross_up[1]

// Check if we're within WT sell window (only evaluate on confirmed bars)
wt_sell_window_active = wt_sell_window_bars > 0 or wt_cross_down or wt_cross_down[1]

// BB Conditions for Buy/Sell (within WT window) - using closed candle values only
bb_buy_condition = close > ma_value  // Price above MA (evaluated on closed candle)
bb_sell_condition = close < ma_value  // Price below MA (evaluated on closed candle)

// RSI Conditions for Buy/Sell (within WT window) - using closed candle values only
rsi_buy_condition = rsi >= rsi_buy_threshold_min and rsi <= rsi_buy_threshold_max  // RSI in buy range 54-82
rsi_sell_condition = rsi >= rsi_sell_threshold_min and rsi <= rsi_sell_threshold_max  // RSI in sell range 27-43

// Combined Strategy Signals (detected on closed candle)
// BUY: WT buy window active AND BB buy condition AND RSI buy condition
strategy_buy_condition_met = enable_strategy and wt_buy_window_active and bb_buy_condition and rsi_buy_condition

// SELL: WT sell window active AND BB sell condition AND RSI sell condition
strategy_sell_condition_met = enable_strategy and wt_sell_window_active and bb_sell_condition and rsi_sell_condition

// Entry signals trigger on NEXT candle open (after conditions met on previous closed candle)
// This ensures entries occur at next candle open, not intrabar
// Only evaluate on confirmed bars to avoid intrabar execution
strategy_buy_signal = barstate.isconfirmed and strategy_buy_condition_met[1]  // Signal from previous closed candle
strategy_sell_signal = barstate.isconfirmed and strategy_sell_condition_met[1]  // Signal from previous closed candle

// Track strategy signals for visualization (only trigger once per window)
var bool strategy_buy_triggered = false
var bool strategy_sell_triggered = false

if strategy_buy_signal and not strategy_buy_triggered
    strategy_buy_triggered := true

if strategy_sell_signal and not strategy_sell_triggered
    strategy_sell_triggered := true

// Reset triggers when windows expire
if not wt_buy_window_active and barstate.isconfirmed
    strategy_buy_triggered := false

if not wt_sell_window_active and barstate.isconfirmed
    strategy_sell_triggered := false

// ============================================================================
// PLOTTING
// ============================================================================

// WaveTrend Plot - LazyBear Style
wt_color = wt1 >= wt2 ? color.new(color.green, 0) : color.new(color.red, 0)
plot(show_wt ? wt1 : na, title="WT1", color=wt_color, linewidth=2)
plot(show_wt ? wt2 : na, title="WT2", color=color.new(color.orange, 0), linewidth=1)

// WaveTrend Zero Line
hline(show_wt ? 0 : na, "WT Zero", color=color.new(color.gray, 70), linestyle=hline.style_dashed)

// WaveTrend Cross Dots - LazyBear Style (Green/Red Signals)
// Green dots for bullish crosses (WT1 crosses above WT2) - Buy Signal
plotshape(show_wt and show_wt_dots and wt_cross_up ? wt1 : na, 
     title="WT Bullish Cross", 
     style=shape.circle, 
     location=location.absolute, 
     color=color.new(color.green, 0), 
     size=size.small,
     text="")

// Red dots for bearish crosses (WT1 crosses below WT2) - Sell Signal
plotshape(show_wt and show_wt_dots and wt_cross_down ? wt1 : na, 
     title="WT Bearish Cross", 
     style=shape.circle, 
     location=location.absolute, 
     color=color.new(color.red, 0), 
     size=size.small,
     text="")

// Ideal Bollinger Bands Plot
bb_upper_plot = plot(show_bb ? ideal_bb_upper : na, title="Ideal BB Upper", color=color.new(color.blue, 0), linewidth=1)
bb_basis_plot = plot(show_bb ? ideal_bb_basis : na, title="Ideal BB Basis", color=color.new(color.yellow, 0), linewidth=1, style=plot.style_line)
bb_lower_plot = plot(show_bb ? ideal_bb_lower : na, title="Ideal BB Lower", color=color.new(color.blue, 0), linewidth=1)

// Moving Average Plot (for reference)
plot(show_bb ? ma_value : na, title="MA", color=color.new(color.purple, 0), linewidth=1, style=plot.style_linebr)

// BB Fill
fill_color = bb_source > ideal_bb_upper ? color.new(color.red, 90) : bb_source < ideal_bb_lower ? color.new(color.green, 90) : color.new(color.gray, 95)
fill(bb_upper_plot, bb_lower_plot, color=fill_color, title="BB Fill")

// Ideal BB with MA Buy/Sell Labels
// Note: For labels on price chart, create separate overlay script using bb_buy_signal and bb_sell_signal variables
// Using plotshape with text labels for visibility in indicator panel
plotshape(show_bb and show_bb_labels and bb_buy_signal ? ideal_bb_lower : na, 
     title="BB Buy Signal", 
     style=shape.labelup, 
     location=location.absolute, 
     color=color.new(color.green, 0), 
     textcolor=color.white,
     text="BUY",
     size=size.small)

plotshape(show_bb and show_bb_labels and bb_sell_signal ? ideal_bb_upper : na, 
     title="BB Sell Signal", 
     style=shape.labeldown, 
     location=location.absolute, 
     color=color.new(color.red, 0), 
     textcolor=color.white,
     text="SELL",
     size=size.small)

// RSI Plot
rsi_color = rsi > rsi_overbought ? color.new(color.red, 0) : rsi < rsi_oversold ? color.new(color.green, 0) : color.new(color.blue, 0)
plot(show_rsi ? rsi : na, title="RSI", color=rsi_color, linewidth=2)

// RSI Levels (Traditional)
hline(show_rsi ? rsi_overbought : na, "RSI Overbought", color=color.new(color.red, 50), linestyle=hline.style_dashed)
hline(show_rsi ? rsi_oversold : na, "RSI Oversold", color=color.new(color.green, 50), linestyle=hline.style_dashed)
hline(show_rsi ? 50 : na, "RSI Midline", color=color.new(color.gray, 70), linestyle=hline.style_dotted)

// RSI Buy/Sell Threshold Levels (Ranges)
hline(show_rsi ? rsi_buy_threshold_min : na, "RSI Buy Threshold Min", color=color.new(color.green, 30), linestyle=hline.style_solid, linewidth=1)
hline(show_rsi ? rsi_buy_threshold_max : na, "RSI Buy Threshold Max", color=color.new(color.green, 30), linestyle=hline.style_solid, linewidth=1)
hline(show_rsi ? rsi_sell_threshold_min : na, "RSI Sell Threshold Min", color=color.new(color.red, 30), linestyle=hline.style_solid, linewidth=1)
hline(show_rsi ? rsi_sell_threshold_max : na, "RSI Sell Threshold Max", color=color.new(color.red, 30), linestyle=hline.style_solid, linewidth=1)

// RSI Buy/Sell Signal Labels
plotshape(show_rsi and show_rsi_signals and rsi_buy_signal ? rsi : na, 
     title="RSI Buy Signal", 
     style=shape.labelup, 
     location=location.absolute, 
     color=color.new(color.green, 0), 
     textcolor=color.white,
     text="BUY",
     size=size.small)

plotshape(show_rsi and show_rsi_signals and rsi_sell_signal ? rsi : na, 
     title="RSI Sell Signal", 
     style=shape.labeldown, 
     location=location.absolute, 
     color=color.new(color.red, 0), 
     textcolor=color.white,
     text="SELL",
     size=size.small)

// ============================================================================
// COMBINED STRATEGY SIGNALS VISUALIZATION
// ============================================================================

// Strategy Buy Signal - Large prominent label
plotshape(show_strategy_signals and strategy_buy_signal and not strategy_buy_triggered[1] ? (wt1 + wt2) / 2 : na, 
     title="Strategy BUY", 
     style=shape.labelup, 
     location=location.absolute, 
     color=color.new(color.green, 0), 
     textcolor=color.white,
     text="STRATEGY\nBUY",
     size=size.large)

// Strategy Sell Signal - Large prominent label
plotshape(show_strategy_signals and strategy_sell_signal and not strategy_sell_triggered[1] ? (wt1 + wt2) / 2 : na, 
     title="Strategy SELL", 
     style=shape.labeldown, 
     location=location.absolute, 
     color=color.new(color.red, 0), 
     textcolor=color.white,
     text="STRATEGY\nSELL",
     size=size.large)

// ============================================================================
// ALERTS
// ============================================================================

// WaveTrend Cross Alerts
alertcondition(wt_cross_up, title="WT Bullish Cross", message="WaveTrend Bullish Cross Detected")
alertcondition(wt_cross_down, title="WT Bearish Cross", message="WaveTrend Bearish Cross Detected")

// RSI Alerts (Traditional)
alertcondition(rsi_overbought_signal, title="RSI Overbought", message="RSI Entered Overbought Zone")
alertcondition(rsi_oversold_signal, title="RSI Oversold", message="RSI Entered Oversold Zone")

// RSI Buy/Sell Threshold Alerts
alertcondition(rsi_buy_signal, title="RSI Buy Signal", message="RSI Buy Signal: RSI entered buy range (54-82)")
alertcondition(rsi_sell_signal, title="RSI Sell Signal", message="RSI Sell Signal: RSI entered sell range (27-43)")

// Ideal BB with MA Alerts
alertcondition(bb_buy_signal, title="BB Buy Signal", message="Ideal BB Buy Signal: Price crossed above MA")
alertcondition(bb_sell_signal, title="BB Sell Signal", message="Ideal BB Sell Signal: Price crossed below MA")

// ============================================================================
// WEBHOOK JSON PAYLOAD BUILDERS
// ============================================================================

// Build JSON payload for webhook alerts
// Creates proper JSON structure with all indicator values
build_json_payload(signal_type) =>
    // Format timestamp (Unix timestamp in milliseconds)
    timestamp_ms = time
    
    // WT cross type and window status
    wt_cross_type = wt_cross_up ? "BULLISH" : wt_cross_down ? "BEARISH" : "NONE"
    wt_window_active = wt_buy_window_active or wt_sell_window_active
    
    // RSI condition status
    rsi_condition_met = signal_type == "BUY" ? rsi_buy_condition : rsi_sell_condition
    
    // Build JSON payload (Pine Script compatible format)
    json_str = "{\"symbol\":\"" + syminfo.ticker + "\","
    json_str := json_str + "\"time\":" + str.tostring(timestamp_ms) + ","
    json_str := json_str + "\"signal\":\"" + signal_type + "\","
    json_str := json_str + "\"indicators\":{"
    json_str := json_str + "\"wt\":{"
    json_str := json_str + "\"flag\":" + str.tostring(wt_buy_window_active) + ","
    json_str := json_str + "\"wt1\":" + str.tostring(wt1, "#.##") + ","
    json_str := json_str + "\"wt2\":" + str.tostring(wt2, "#.##") + ","
    json_str := json_str + "\"cross_type\":\"" + wt_cross_type + "\","
    json_str := json_str + "\"window_active\":" + str.tostring(wt_window_active)
    json_str := json_str + "},"
    json_str := json_str + "\"bb\":{"
    json_str := json_str + "\"flag\":" + str.tostring(bb_buy_condition) + ","
    json_str := json_str + "\"upper\":" + str.tostring(ideal_bb_upper, "#.##") + ","
    json_str := json_str + "\"lower\":" + str.tostring(ideal_bb_lower, "#.##") + ","
    json_str := json_str + "\"basis\":" + str.tostring(ideal_bb_basis, "#.##") + ","
    json_str := json_str + "\"ma_value\":" + str.tostring(ma_value, "#.##") + ","
    json_str := json_str + "\"percent_b\":" + str.tostring(bb_percent, "#.####")
    json_str := json_str + "},"
    json_str := json_str + "\"rsi\":{"
    json_str := json_str + "\"value\":" + str.tostring(rsi, "#.##") + ","
    json_str := json_str + "\"buy_threshold_min\":" + str.tostring(rsi_buy_threshold_min) + ","
    json_str := json_str + "\"buy_threshold_max\":" + str.tostring(rsi_buy_threshold_max) + ","
    json_str := json_str + "\"sell_threshold_min\":" + str.tostring(rsi_sell_threshold_min) + ","
    json_str := json_str + "\"sell_threshold_max\":" + str.tostring(rsi_sell_threshold_max) + ","
    json_str := json_str + "\"condition_met\":" + str.tostring(rsi_condition_met)
    json_str := json_str + "}"
    json_str := json_str + "},"
    json_str := json_str + "\"price\":{"
    json_str := json_str + "\"close\":" + str.tostring(close, "#.##") + ","
    json_str := json_str + "\"open\":" + str.tostring(open, "#.##") + ","
    json_str := json_str + "\"high\":" + str.tostring(high, "#.##") + ","
    json_str := json_str + "\"low\":" + str.tostring(low, "#.##")
    json_str := json_str + "},"
    json_str := json_str + "\"strategy\":{"
    json_str := json_str + "\"entry_type\":\"NEXT_CANDLE_OPEN\","
    json_str := json_str + "\"all_conditions_met\":true"
    json_str := json_str + "}}"
    json_str

// Build pipe-delimited message (alternative format for compatibility)
build_webhook_message(signal_type) =>
    timestamp_str = str.tostring(time)
    wt_cross_type = wt_cross_up ? "BULLISH" : wt_cross_down ? "BEARISH" : "NONE"
    wt_window_status = wt_buy_window_active ? "BUY" : wt_sell_window_active ? "SELL" : "NONE"
    wt_flag_str = str.tostring(wt_buy_window_active)
    bb_flag_str = str.tostring(bb_buy_condition)
    rsi_condition_str = str.tostring(signal_type == "BUY" ? rsi_buy_condition : rsi_sell_condition)
    
    // Build message incrementally (Pine Script doesn't support line continuation)
    msg = "SYMBOL=" + syminfo.ticker + "|"
    msg := msg + "TIME=" + timestamp_str + "|"
    msg := msg + "SIGNAL=" + signal_type + "|"
    msg := msg + "WT_FLAG=" + wt_flag_str + "|"
    msg := msg + "WT1=" + str.tostring(wt1, "#.##") + "|"
    msg := msg + "WT2=" + str.tostring(wt2, "#.##") + "|"
    msg := msg + "WT_CROSS=" + wt_cross_type + "|"
    msg := msg + "WT_WINDOW=" + wt_window_status + "|"
    msg := msg + "BB_FLAG=" + bb_flag_str + "|"
    msg := msg + "BB_UPPER=" + str.tostring(ideal_bb_upper, "#.##") + "|"
    msg := msg + "BB_LOWER=" + str.tostring(ideal_bb_lower, "#.##") + "|"
    msg := msg + "BB_BASIS=" + str.tostring(ideal_bb_basis, "#.##") + "|"
    msg := msg + "MA_VALUE=" + str.tostring(ma_value, "#.##") + "|"
    msg := msg + "BB_PERCENT=" + str.tostring(bb_percent, "#.####") + "|"
    msg := msg + "RSI_VALUE=" + str.tostring(rsi, "#.##") + "|"
    msg := msg + "RSI_BUY_THRESHOLD_MIN=" + str.tostring(rsi_buy_threshold_min) + "|"
    msg := msg + "RSI_BUY_THRESHOLD_MAX=" + str.tostring(rsi_buy_threshold_max) + "|"
    msg := msg + "RSI_SELL_THRESHOLD_MIN=" + str.tostring(rsi_sell_threshold_min) + "|"
    msg := msg + "RSI_SELL_THRESHOLD_MAX=" + str.tostring(rsi_sell_threshold_max) + "|"
    msg := msg + "RSI_CONDITION=" + rsi_condition_str + "|"
    msg := msg + "PRICE_CLOSE=" + str.tostring(close, "#.##") + "|"
    msg := msg + "PRICE_OPEN=" + str.tostring(open, "#.##") + "|"
    msg := msg + "PRICE_HIGH=" + str.tostring(high, "#.##") + "|"
    msg := msg + "PRICE_LOW=" + str.tostring(low, "#.##") + "|"
    msg := msg + "ENTRY_TYPE=NEXT_CANDLE_OPEN"
    msg

// ============================================================================
// ALERT CONDITIONS - JSON OUTPUT (All Three Indicators Must Align)
// ============================================================================

// Verify all three indicators are fully aligned before firing alert
// These conditions ensure WT, BB, and RSI are all aligned simultaneously
// BUY Signal: WT buy window + BB buy condition + RSI buy condition
all_indicators_aligned_buy = enable_strategy and 
                             wt_buy_window_active and 
                             bb_buy_condition and 
                             rsi_buy_condition

// SELL Signal: WT sell window + BB sell condition + RSI sell condition  
all_indicators_aligned_sell = enable_strategy and 
                              wt_sell_window_active and 
                              bb_sell_condition and 
                              rsi_sell_condition

// Combined Strategy Alerts with JSON Output
// Alerts fire ONLY when:
// 1. Strategy signal is active (conditions met on previous closed candle)
// 2. All three indicators are still fully aligned on current bar
// 3. Signal hasn't been triggered already (prevents duplicates)
// Entry occurs on NEXT candle open (after conditions met on previous closed candle)
// IMPORTANT: TradingView sends the message as-is. If it's valid JSON, it uses "application/json" content-type.
// We build the full JSON payload here so TradingView sends it correctly to the webhook.
alertcondition(strategy_buy_signal and not strategy_buy_triggered[1] and all_indicators_aligned_buy, 
     title="Strategy Buy Signal (JSON)", 
     message=build_json_payload("BUY"))

alertcondition(strategy_sell_signal and not strategy_sell_triggered[1] and all_indicators_aligned_sell, 
     title="Strategy Sell Signal (JSON)", 
     message=build_json_payload("SELL"))

// Alternative: Pipe-delimited format alerts (for backward compatibility)
alertcondition(strategy_buy_signal and not strategy_buy_triggered[1] and all_indicators_aligned_buy, 
     title="Strategy Buy Signal (Webhook)", 
     message=build_webhook_message("BUY"))

alertcondition(strategy_sell_signal and not strategy_sell_triggered[1] and all_indicators_aligned_sell, 
     title="Strategy Sell Signal (Webhook)", 
     message=build_webhook_message("SELL"))

// ============================================================================
// TABLE DISPLAY (Optional - shows current values)
// ============================================================================

if barstate.islast
    var table info_table = table.new(position.top_right, 2, 6, bgcolor=color.new(color.white, 80), border_width=1)
    
    table.cell(info_table, 0, 0, "Indicator", text_color=color.black, bgcolor=color.new(color.gray, 70))
    table.cell(info_table, 1, 0, "Value", text_color=color.black, bgcolor=color.new(color.gray, 70))
    
    table.cell(info_table, 0, 1, "WT1", text_color=color.black)
    table.cell(info_table, 1, 1, str.tostring(wt1, "#.##"), text_color=wt1 >= wt2 ? color.green : color.red)
    
    table.cell(info_table, 0, 2, "RSI(12)", text_color=color.black)
    rsi_table_color = (rsi >= rsi_buy_threshold_min and rsi <= rsi_buy_threshold_max) ? color.green : (rsi >= rsi_sell_threshold_min and rsi <= rsi_sell_threshold_max) ? color.red : rsi > rsi_overbought ? color.red : rsi < rsi_oversold ? color.green : color.blue
    table.cell(info_table, 1, 2, str.tostring(rsi, "#.##"), text_color=rsi_table_color)
    
    table.cell(info_table, 0, 3, "%B", text_color=color.black)
    table.cell(info_table, 1, 3, str.tostring(bb_percent * 100, "#.##") + "%", text_color=color.black)
    
    // Strategy Status
    table.cell(info_table, 0, 4, "WT Window", text_color=color.black)
    wt_window_status = wt_buy_window_active ? "BUY Active" : wt_sell_window_active ? "SELL Active" : "None"
    wt_window_color = wt_buy_window_active ? color.green : wt_sell_window_active ? color.red : color.gray
    table.cell(info_table, 1, 4, wt_window_status, text_color=wt_window_color)
    
    table.cell(info_table, 0, 5, "Strategy", text_color=color.black)
    strategy_status = strategy_buy_signal ? "BUY" : strategy_sell_signal ? "SELL" : "Waiting"
    strategy_status_color = strategy_buy_signal ? color.green : strategy_sell_signal ? color.red : color.gray
    table.cell(info_table, 1, 5, strategy_status, text_color=strategy_status_color)

